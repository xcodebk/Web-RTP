function error(){alert("Stream generation failed.")}function getUserMedia(a,b){try{navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia,navigator.getUserMedia(a,b,error)}catch(a){alert("getUserMedia threw exception :"+a)}}function gotStream(a){mediaStreamSource=audioContext.createMediaStreamSource(a),analyser=audioContext.createAnalyser(),analyser.fftSize=2048,mediaStreamSource.connect(analyser),updatePitch()}function toggleOscillator(){return isPlaying?(sourceNode.stop(0),sourceNode=null,analyser=null,isPlaying=!1,window.cancelAnimationFrame||(window.cancelAnimationFrame=window.webkitCancelAnimationFrame),window.cancelAnimationFrame(rafID),"play oscillator"):(sourceNode=audioContext.createOscillator(),analyser=audioContext.createAnalyser(),analyser.fftSize=2048,sourceNode.connect(analyser),analyser.connect(audioContext.destination),sourceNode.start(0),isPlaying=!0,isLiveInput=!1,updatePitch(),"stop")}function toggleLiveInput(){isPlaying&&(sourceNode.stop(0),sourceNode=null,analyser=null,isPlaying=!1,window.cancelAnimationFrame||(window.cancelAnimationFrame=window.webkitCancelAnimationFrame),window.cancelAnimationFrame(rafID)),getUserMedia({audio:{mandatory:{googEchoCancellation:"false",googAutoGainControl:"false",googNoiseSuppression:"false",googHighpassFilter:"false"},optional:[]}},gotStream)}function togglePlayback(){return isPlaying?(sourceNode.stop(0),sourceNode=null,analyser=null,isPlaying=!1,window.cancelAnimationFrame||(window.cancelAnimationFrame=window.webkitCancelAnimationFrame),window.cancelAnimationFrame(rafID),"start"):(sourceNode=audioContext.createBufferSource(),sourceNode.buffer=theBuffer,sourceNode.loop=!0,analyser=audioContext.createAnalyser(),analyser.fftSize=2048,sourceNode.connect(analyser),analyser.connect(audioContext.destination),sourceNode.start(0),isPlaying=!0,isLiveInput=!1,updatePitch(),"stop")}function noteFromPitch(a){var b=12*(Math.log(a/440)/Math.log(2));return Math.round(b)+69}function frequencyFromNoteNumber(a){return 440*Math.pow(2,(a-69)/12)}function centsOffFromPitch(a,b){return Math.floor(1200*Math.log(a/frequencyFromNoteNumber(b))/Math.log(2))}function autoCorrelate(a,b){for(var c=a.length,d=Math.floor(c/2),e=-1,f=0,g=0,h=!1,i=new Array(d),j=0;j<c;j++){var k=a[j];g+=k*k}if(g=Math.sqrt(g/c),g<.01)return-1;for(var l=1,m=MIN_SAMPLES;m<d;m++){for(var n=0,j=0;j<d;j++)n+=Math.abs(a[j]-a[j+m]);if(n=1-n/d,i[m]=n,n>GOOD_ENOUGH_CORRELATION&&n>l)h=!0,n>f&&(f=n,e=m);else if(h){var o=(i[e+1]-i[e-1])/i[e];return b/(e+8*o)}l=n}return f>.01?b/e:-1}function updatePitch(a){new Array;analyser.getFloatTimeDomainData(buf);var c=autoCorrelate(buf,audioContext.sampleRate);if(DEBUGCANVAS){waveCanvas.clearRect(0,0,512,256),waveCanvas.strokeStyle="red",waveCanvas.beginPath(),waveCanvas.moveTo(0,0),waveCanvas.lineTo(0,256),waveCanvas.moveTo(128,0),waveCanvas.lineTo(128,256),waveCanvas.moveTo(256,0),waveCanvas.lineTo(256,256),waveCanvas.moveTo(384,0),waveCanvas.lineTo(384,256),waveCanvas.moveTo(512,0),waveCanvas.lineTo(512,256),waveCanvas.stroke(),waveCanvas.strokeStyle="black",waveCanvas.beginPath(),waveCanvas.moveTo(0,buf[0]);for(var d=1;d<512;d++)waveCanvas.lineTo(d,128+128*buf[d]);waveCanvas.stroke()}if(c==-1)detectorElem.className="vague",pitchElem.innerText="--Hz",noteElem.innerText="--",detuneElem.className="",detuneAmount.innerText="--";else{detectorElem.className="confident",pitch=c,pitchElem.innerText=Math.round(pitch)+' Hz';var e=noteFromPitch(pitch);noteElem.innerHTML=noteStrings[e%12];var f=centsOffFromPitch(pitch,e);0==f?(detuneElem.className="",detuneAmount.innerHTML="--"):(f<0?detuneElem.className="flat":detuneElem.className="sharp",detuneAmount.innerHTML=Math.abs(f))}window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame),rafID=window.requestAnimationFrame(updatePitch)}window.AudioContext=window.AudioContext||window.webkitAudioContext;var audioContext=null,isPlaying=!1,sourceNode=null,analyser=null,theBuffer=null,DEBUGCANVAS=null,mediaStreamSource=null,detectorElem,canvasElem,waveCanvas,pitchElem,noteElem,detuneElem,detuneAmount;window.onload=function(){audioContext=new AudioContext,MAX_SIZE=Math.max(4,Math.floor(audioContext.sampleRate/5e3));var a=new XMLHttpRequest;a.open("GET","../sounds/whistling3.ogg",!0),a.responseType="arraybuffer",a.onload=function(){audioContext.decodeAudioData(a.response,function(a){theBuffer=a})},a.send(),detectorElem=document.getElementById("detector"),canvasElem=document.getElementById("output"),DEBUGCANVAS=document.getElementById("waveform"),DEBUGCANVAS&&(waveCanvas=DEBUGCANVAS.getContext("2d"),waveCanvas.strokeStyle="black",waveCanvas.lineWidth=1),pitchElem=document.getElementById("pitch"),noteElem=document.getElementById("note"),detuneElem=document.getElementById("detune"),detuneAmount=document.getElementById("detune_amt"),detectorElem.ondragenter=function(){return this.classList.add("droptarget"),!1},detectorElem.ondragleave=function(){return this.classList.remove("droptarget"),!1},detectorElem.ondrop=function(a){this.classList.remove("droptarget"),a.preventDefault(),theBuffer=null;var b=new FileReader;return b.onload=function(a){audioContext.decodeAudioData(a.target.result,function(a){theBuffer=a},function(){alert("error loading!")})},b.onerror=function(a){alert("Error: "+b.error)},b.readAsArrayBuffer(a.dataTransfer.files[0]),!1}};var rafID=null,tracks=null,buflen=1024,buf=new Float32Array(buflen),noteStrings=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],MIN_SAMPLES=0,GOOD_ENOUGH_CORRELATION=.9;toggleLiveInput();
